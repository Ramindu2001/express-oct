name: Express CI/CD to EC2 (PM2)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: express-oct-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e

            APP_DIR="/home/ubuntu/backend/express-oct"
            PM2_ID="0"

            echo "==> Go to app directory"
            cd "$APP_DIR"

            echo "==> Ensure git safe directory"
            git config --global --add safe.directory "$APP_DIR"

            echo "==> Fetch latest code"
            git fetch --all
            git reset --hard origin/main

            echo "==> Setup NVM (install if missing)"
            export NVM_DIR="$HOME/.nvm"
            if [ ! -s "$NVM_DIR/nvm.sh" ]; then
              echo "NVM not found. Installing..."
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
            fi

            # Load nvm
            . "$NVM_DIR/nvm.sh"

            echo "==> Install / use Node version"
            # If your repo has .nvmrc, it will use that. Otherwise uses LTS.
            if [ -f ".nvmrc" ]; then
              nvm install
              nvm use
            else
              nvm install --lts
              nvm use --lts
            fi

            echo "==> Node & npm versions"
            node -v
            npm -v

            echo "==> Install dependencies"
            npm ci || npm install

            echo "==> Restart PM2 (id: $PM2_ID)"
            pm2 restart "$PM2_ID" --update-env

            echo "==> Save PM2 process list"
            pm2 save

            echo "âœ… Deploy complete"